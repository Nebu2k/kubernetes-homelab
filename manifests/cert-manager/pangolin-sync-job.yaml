---
# PostSync Hook: Runs after every ArgoCD sync
apiVersion: batch/v1
kind: Job
metadata:
  name: pangolin-sync-postsync
  namespace: cert-manager
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300 # Clean up after 5min
  template:
    spec:
      serviceAccountName: pangolin-sync
      restartPolicy: OnFailure
      containers:
        - name: sync
          image: nebu2k/pangolin-sync:1.0-alpine3.23
          imagePullPolicy: Always
          envFrom:
            - secretRef:
                name: pangolin-api-credentials
---
# CronJob: Runs every 5 minutes
apiVersion: batch/v1
kind: CronJob
metadata:
  name: pangolin-sync
  namespace: cert-manager
spec:
  schedule: "*/5 * * * *" # Every 5 minutes
  concurrencyPolicy: Forbid # Prevent overlapping runs
  startingDeadlineSeconds: 300 # Skip if job start is delayed >5min
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 3600 # Clean up after 1h
      template:
        spec:
          serviceAccountName: pangolin-sync
          restartPolicy: OnFailure
          containers:
            - name: sync
              image: nebu2k/pangolin-sync:1.0-alpine3.23
              imagePullPolicy: Always
              envFrom:
                - secretRef:
                    name: pangolin-api-credentials
