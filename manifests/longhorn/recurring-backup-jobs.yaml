# Longhorn Recurring Backup Jobs
# WICHTIG: concurrency auf 1 reduziert um etcd-Überlastung zu vermeiden
# Schedule gespreizt um nicht mehrere Jobs gleichzeitig laufen zu lassen
#
# S3 Backup Jobs (Default) - Alle Volumes nutzen Standard S3 Backup Target
---
# === S3 BACKUPS (Default) ===
# Tägliches S3 Backup um 2:00 Uhr (behält 7 Tage)
apiVersion: longhorn.io/v1beta2
kind: RecurringJob
metadata:
  name: backup-daily
  namespace: longhorn-system
spec:
  cron: "0 2 * * *"
  task: "backup"
  retain: 7
  concurrency: 1
  labels: {}
---
# Wöchentliches S3 Backup (Sonntags um 3:00 Uhr, behält 4 Wochen)
apiVersion: longhorn.io/v1beta2
kind: RecurringJob
metadata:
  name: backup-weekly
  namespace: longhorn-system
spec:
  cron: "0 3 * * 0"
  task: "backup"
  retain: 4
  concurrency: 1
  labels: {}
---
# === CLEANUP JOBS (für beide Targets) ===
# Tägliche Snapshot Cleanup (8:00 Uhr - VERSCHOBEN von 4:00 Uhr)
# Läuft jetzt 6 Stunden NACH dem Backup, um etcd Zeit zum Erholen zu geben
apiVersion: longhorn.io/v1beta2
kind: RecurringJob
metadata:
  name: snapshot-cleanup-daily
  namespace: longhorn-system
spec:
  cron: "0 8 * * *"  # Verschoben von 04:00 auf 08:00 UTC (09:00 CET)
  task: "snapshot-cleanup"
  retain: 0
  concurrency: 2  # Reduziert von 5 auf 2
  labels: {}
