# Longhorn Recurring Jobs - Backups & Snapshots
# WICHTIG: concurrency auf 1 reduziert um etcd-Überlastung zu vermeiden
# Schedule gespreizt um nicht mehrere Jobs gleichzeitig laufen zu lassen
#
# Retention Strategy (GFS - Grandfather-Father-Son):
# - keep_last    = 3  (letzte 3 Backups)
# - keep_daily   = 7  (7 tägliche)
# - keep_weekly  = 4  (4 wöchentliche)
# - keep_monthly = 6  (6 monatliche)
# - keep_yearly  = 1  (1 jährliches)
#
# Snapshots: Lokal im Cluster (schnelles Recovery)
# Backups: S3 MinIO (Disaster Recovery)
---
# === SNAPSHOTS (Lokal) ===
# Täglicher Snapshot um 1:00 Uhr (behält 7 Tage)
apiVersion: longhorn.io/v1beta2
kind: RecurringJob
metadata:
  name: snapshot-daily
  namespace: longhorn-system
spec:
  cron: "0 1 * * *"
  task: "snapshot"
  retain: 7
  concurrency: 1
  groups:
    - snapshot
  labels: {}
---
# Snapshot Cleanup (täglich 8:00 Uhr)
# WICHTIG: In snapshot Gruppe, nicht backup Gruppe!
apiVersion: longhorn.io/v1beta2
kind: RecurringJob
metadata:
  name: snapshot-cleanup-daily
  namespace: longhorn-system
spec:
  cron: "0 8 * * *"
  task: "snapshot-cleanup"
  retain: 0
  concurrency: 2
  groups:
    - snapshot
  labels: {}
---
# === MAINTENANCE TASKS ===
# Filesystem Trim (wöchentlich Sonntags 7:00 Uhr)
# Gibt freien Speicher an SSD/NVMe zurück, verbessert Performance
apiVersion: longhorn.io/v1beta2
kind: RecurringJob
metadata:
  name: filesystem-trim-weekly
  namespace: longhorn-system
spec:
  cron: "0 7 * * 0"
  task: "filesystem-trim"
  retain: 0
  concurrency: 1
  groups:
    - maintenance
  labels: {}
---
# === BACKUPS (S3 MinIO) ===
# Tägliches Backup um 2:00 Uhr (behält 7 Tage)
apiVersion: longhorn.io/v1beta2
kind: RecurringJob
metadata:
  name: backup-daily
  namespace: longhorn-system
spec:
  cron: "0 2 * * *"
  task: "backup"
  retain: 7
  concurrency: 1
  groups:
    - backup
  labels: {}
---
# Wöchentliches Backup (Sonntags um 3:00 Uhr, behält 4 Wochen)
apiVersion: longhorn.io/v1beta2
kind: RecurringJob
metadata:
  name: backup-weekly
  namespace: longhorn-system
spec:
  cron: "0 3 * * 0"
  task: "backup"
  retain: 4
  concurrency: 1
  groups:
    - backup
  labels: {}
---
# Monatliches Backup (1. des Monats um 4:00 Uhr, behält 6 Monate)
apiVersion: longhorn.io/v1beta2
kind: RecurringJob
metadata:
  name: backup-monthly
  namespace: longhorn-system
spec:
  cron: "0 4 1 * *"
  task: "backup"
  retain: 6
  concurrency: 1
  groups:
    - backup
  labels: {}
---
# Jährliches Backup (1. Januar um 5:00 Uhr, behält 1 Jahr)
apiVersion: longhorn.io/v1beta2
kind: RecurringJob
metadata:
  name: backup-yearly
  namespace: longhorn-system
spec:
  cron: "0 5 1 1 *"
  task: "backup"
  retain: 1
  concurrency: 1
  groups:
    - backup
  labels: {}
---
# === SYSTEM BACKUPS (Longhorn System) ===
# Sichert Longhorn-Systemkonfiguration selbst
# Tägliches System-Backup um 6:00 Uhr (behält 7 Tage)
apiVersion: longhorn.io/v1beta2
kind: RecurringJob
metadata:
  name: system-backup-daily
  namespace: longhorn-system
spec:
  cron: "0 6 * * *"
  task: "system-backup"
  retain: 7
  concurrency: 1
  labels: {}