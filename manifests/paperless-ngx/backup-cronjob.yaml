apiVersion: batch/v1
kind: CronJob
metadata:
  name: paperless-backup-s3
  namespace: paperless-ngx
  labels:
    app.kubernetes.io/name: paperless-backup
spec:
  schedule: "0 2 * * *"  # Daily at 02:00 UTC
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: paperless-backup
        spec:
          serviceAccountName: paperless-backup-sa
          restartPolicy: OnFailure
          containers:
          - name: backup-orchestrator
            image: rancher/kubectl:v1.35.0
            command:
            - /bin/bash
            - -c
            - |
              set -euxo pipefail

              # For production, use custom image with aws-cli pre-installed
              echo "Installing AWS CLI..."
              apt-get update -qq && apt-get install -y -qq awscli > /dev/null 2>&1

              echo "=== Paperless-ngx S3 Backup Started ==="
              TIMESTAMP=$(date +%Y-%m-%d-%H%M%S)
              REMOTE_EXPORT_DIR="/export/backup-${TIMESTAMP}"
              LOCAL_STAGING_DIR="/tmp/staging"

              # Step 1: Export documents inside running Paperless pod
              echo "Step 1: Running document export in Paperless pod..."
              kubectl exec -n paperless-ngx deployment/paperless-ngx -c paperless-ngx -- \
                bash -c "mkdir -p ${REMOTE_EXPORT_DIR} && python /usr/src/paperless/src/manage.py document_exporter ${REMOTE_EXPORT_DIR}"

              # Step 2: Find the paperless pod name
              PAPERLESS_POD=$(kubectl get pods -n paperless-ngx -l app.kubernetes.io/name=paperless-ngx,app=paperless-ngx -o jsonpath='{.items[0].metadata.name}')
              if [ -z "$PAPERLESS_POD" ]; then
                echo "ERROR: Paperless pod not found!"
                exit 1
              fi
              echo "Found pod: ${PAPERLESS_POD}"

              # Step 3: Copy exported files from paperless pod to this pod
              echo "Step 3: Copying files from ${PAPERLESS_POD}:${REMOTE_EXPORT_DIR} to ${LOCAL_STAGING_DIR}..."
              mkdir -p "${LOCAL_STAGING_DIR}"
              kubectl cp "paperless-ngx/${PAPERLESS_POD}:${REMOTE_EXPORT_DIR}/." "${LOCAL_STAGING_DIR}" -c paperless-ngx

              # Step 4: Upload to S3 using /latest/ path (S3 Versioning handles history)
              echo "Step 4: Uploading to S3..."
              S3_PATH="s3://${S3_BUCKET_NAME}/paperless-backup/latest/"
              echo "Note: S3 Versioning enabled - only changed files will use additional storage"
              
              aws s3 sync "${LOCAL_STAGING_DIR}" "${S3_PATH}" \
                --region "${S3_REGION}" \
                --storage-class STANDARD_IA \
                --delete \
                --no-progress

              if [ $? -eq 0 ]; then
                echo "Upload successful!"
              else
                echo "ERROR: Upload failed!"
                exit 1
              fi

              # Step 5: Cleanup old exports in paperless pod (keeps last 2)
              echo "Step 5: Cleaning up old exports in paperless pod..."
              kubectl exec -n paperless-ngx deployment/paperless-ngx -c paperless-ngx -- \
                bash -c "ls -td /export/backup-* 2>/dev/null | tail -n +3 | xargs -r rm -rf"

              echo "Backup completed successfully!"
            env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: s3-backup-credentials
                  key: AWS_ACCESS_KEY_ID
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: s3-backup-credentials
                  key: AWS_SECRET_ACCESS_KEY
            - name: S3_BUCKET_NAME
              valueFrom:
                secretKeyRef:
                  name: s3-backup-credentials
                  key: S3_BUCKET_NAME
            - name: S3_REGION
              valueFrom:
                secretKeyRef:
                  name: s3-backup-credentials
                  key: S3_REGION
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 512Mi
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: paperless-backup-sa
  namespace: paperless-ngx
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: paperless-backup-role
  namespace: paperless-ngx
rules:
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["pods", "pods/exec"]
  verbs: ["get", "list", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: paperless-backup-rolebinding
  namespace: paperless-ngx
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: paperless-backup-role
subjects:
- kind: ServiceAccount
  name: paperless-backup-sa
  namespace: paperless-ngx
