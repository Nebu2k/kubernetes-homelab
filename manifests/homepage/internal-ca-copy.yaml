---
# CronJob to copy Internal CA certificate from cert-manager to homepage namespace
# This allows homepage pods to trust internal services
apiVersion: batch/v1
kind: CronJob
metadata:
  name: copy-internal-ca
  namespace: homepage
spec:
  schedule: "0 */12 * * *"  # Every 12 hours
  concurrencyPolicy: Replace
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: ca-copier
          restartPolicy: OnFailure
          containers:
            - name: copy-ca
              image: alpine:3.23
              command:
                - /bin/sh
                - -c
                - |
                  set -eux
                  
                  # Detect architecture and download correct kubectl
                  ARCH=$(uname -m)
                  case "$ARCH" in
                    x86_64)  KUBECTL_ARCH="amd64" ;;
                    aarch64) KUBECTL_ARCH="arm64" ;;
                    armv7l)  KUBECTL_ARCH="arm" ;;
                    *)       echo "Unsupported architecture: $ARCH"; exit 1 ;;
                  esac
                  
                  echo "Detected architecture: $ARCH, downloading kubectl for $KUBECTL_ARCH"
                  apk add --no-cache curl
                  curl -sLO "https://dl.k8s.io/release/v1.35.0/bin/linux/${KUBECTL_ARCH}/kubectl"
                  chmod +x kubectl
                  mv kubectl /usr/local/bin/
                  
                  # Get CA certificate from cert-manager namespace
                  kubectl get secret internal-ca-secret -n cert-manager -o jsonpath='{.data.ca\.crt}' > /tmp/ca.crt
                  
                  # Create or update secret in homepage namespace
                  kubectl create secret generic internal-ca-secret \
                    --from-file=ca.crt=/tmp/ca.crt \
                    --namespace=homepage \
                    --dry-run=client -o yaml | kubectl apply -f -
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ca-copier
  namespace: homepage
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ca-copier
  namespace: homepage
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ca-copier
  namespace: homepage
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ca-copier
subjects:
  - kind: ServiceAccount
    name: ca-copier
    namespace: homepage

