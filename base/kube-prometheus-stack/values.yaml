# kube-prometheus-stack Helm values
# Optimized for Raspberry Pi homelab

# Global settings
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: false  # K3s uses embedded SQLite by default
    kubeScheduler: false  # K3s scheduler metrics not exposed
    kubeControllerManager: false  # K3s controller metrics not exposed
    kubeProxy: false  # K3s uses kube-router instead of kube-proxy

# Prometheus configuration
prometheus:
  prometheusSpec:
    # Resource limits (conservative for Pi)
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 2Gi
    
    # Run on worker nodes only
    nodeSelector:
      node-role.kubernetes.io/worker: worker
    
    # Storage configuration
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 20Gi
    
    # Retention policy
    retention: 30d
    retentionSize: "18GB"
    
    # Service monitors
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false

# Grafana configuration
grafana:
  enabled: true
  
  # Admin credentials (change in production!)
  adminPassword: prom-operator
  
  # Run on worker nodes only
  nodeSelector:
    node-role.kubernetes.io/worker: worker
  
  # Persistence
  persistence:
    enabled: true
    storageClassName: longhorn
    size: 5Gi
  
  # Ingress will be configured in overlays/production
  ingress:
    enabled: false
  
  # Resources (conservative for Pi)
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Pre-installed dashboards
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default
  
  # Additional dashboards
  dashboards:
    default:
      # Kubernetes cluster overview
      kubernetes-cluster:
        gnetId: 7249
        revision: 1
        datasource: Prometheus
      # Node exporter full
      node-exporter:
        gnetId: 1860
        revision: 31
        datasource: Prometheus
      # Longhorn dashboard
      longhorn:
        gnetId: 13032
        revision: 6
        datasource: Prometheus
      # NGINX Ingress Controller
      nginx-ingress:
        gnetId: 9614
        revision: 1
        datasource: Prometheus

# Alert Manager
alertmanager:
  enabled: true
  
  # AlertManager configuration - Email via Amazon SES
  # SMTP credentials are mounted from sealed secret: alertmanager-smtp-credentials
  config:
    global:
      resolve_timeout: 5m
      smtp_from: '{{ env "SMTP_FROM" }}'
      smtp_smarthost: '{{ env "SMTP_SMARTHOST" }}'
      smtp_auth_username: '{{ env "SMTP_USERNAME" }}'
      smtp_auth_password: '{{ env "SMTP_PASSWORD" }}'
      smtp_require_tls: true

    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      receiver: 'email-default'
      routes:
        # Critical alerts get sent immediately
        - match:
            severity: critical
          receiver: 'email-critical'
          group_wait: 0s
          repeat_interval: 4h
        
        # Warning alerts are grouped
        - match:
            severity: warning
          receiver: 'email-warning'
          group_wait: 30s
          repeat_interval: 12h

    receivers:
      - name: 'email-default'
        email_configs:
          - to: '{{ env "SMTP_TO" }}'
            headers:
              Subject: '[Homelab Alert] {{ .GroupLabels.alertname }}'
            send_resolved: true

      - name: 'email-critical'
        email_configs:
          - to: '{{ env "SMTP_TO" }}'
            headers:
              Subject: 'üö® [CRITICAL] {{ .GroupLabels.alertname }}'
            send_resolved: true

      - name: 'email-warning'
        email_configs:
          - to: '{{ env "SMTP_TO" }}'
            headers:
              Subject: '‚ö†Ô∏è  [WARNING] {{ .GroupLabels.alertname }}'
            send_resolved: true

    inhibit_rules:
      # Inhibit warning if critical alert is firing
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'instance']
  
  alertmanagerSpec:
    # Inject SMTP credentials from sealed secret as environment variables
    containers:
      - name: alertmanager
        envFrom:
          - secretRef:
              name: alertmanager-smtp-credentials
    
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi
    
    # Run on worker nodes only
    nodeSelector:
      node-role.kubernetes.io/worker: worker
    
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 2Gi

# Node exporter (collects node metrics)
nodeExporter:
  enabled: true

# Kube-state-metrics (cluster state metrics) - note: uses hyphens not camelCase
kube-state-metrics:
  nodeSelector:
    node-role.kubernetes.io/worker: "worker"

# Prometheus Operator
prometheusOperator:
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Run on worker nodes only
  nodeSelector:
    node-role.kubernetes.io/worker: worker
  
  # Enable monitoring of namespaces
  namespaces:
    releaseNamespace: true
    additional:
      - kube-system
      - ingress-nginx
      - cert-manager
      - longhorn-system
      - home-assistant
      - teslamate

# Service Monitors for additional components
additionalServiceMonitors:
  # Monitor NGINX Ingress Controller
  - name: nginx-ingress-controller
    selector:
      matchLabels:
        app.kubernetes.io/name: ingress-nginx
    namespaceSelector:
      matchNames:
        - ingress-nginx
    endpoints:
      - port: metrics
        interval: 30s
