# kube-prometheus-stack Helm values
# https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack

# Global settings
fullnameOverride: prometheus

# Enable auto-reload when config changes
commonLabels:
  reloader.stakater.com/auto: "true"

# Prometheus Operator
prometheusOperator:
  enabled: true
  
  # Schedule only on worker nodes
  nodeSelector:
    node-role.kubernetes.io/worker: "worker"
  
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      memory: 256Mi

# Prometheus
prometheus:
  enabled: true
  prometheusSpec:
    # Schedule only on worker nodes
    nodeSelector:
      node-role.kubernetes.io/worker: "worker"
    
    # Retention
    retention: 30d
    retentionSize: 10GB
    
    # Storage
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 15Gi
    
    # Resources
    resources:
      requests:
        cpu: 200m
        memory: 1Gi
      limits:
        memory: 2Gi
    
    # Service Monitors
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    
    # Scrape all namespaces
    serviceMonitorNamespaceSelector: {}
    podMonitorNamespaceSelector: {}
    
    # Enable reloader annotation
    podMetadata:
      annotations:
        reloader.stakater.com/auto: "true"

# Grafana - Enable in K8s (parallel to Docker)
grafana:
  enabled: true
  
  # Schedule only on worker nodes
  nodeSelector:
    node-role.kubernetes.io/worker: "worker"
  
  # Admin credentials from secret via environment variables
  envValueFrom:
    GF_SECURITY_ADMIN_USER:
      secretKeyRef:
        name: grafana-admin-secret
        key: admin-user
    GF_SECURITY_ADMIN_PASSWORD:
      secretKeyRef:
        name: grafana-admin-secret
        key: admin-password
  
  # Service
  service:
    type: ClusterIP  # Use Ingress instead of LoadBalancer
    port: 80
  
  # Ingress will be added in overlay
  ingress:
    enabled: false
  
  # Persistence
  persistence:
    enabled: true
    storageClassName: longhorn
    size: 5Gi
  
  # Resources
  resources:
    requests:
      cpu: 50m
      memory: 256Mi
    limits:
      memory: 512Mi
  
  # Datasources - Prometheus
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          url: http://prometheus-kube-prometheus-prometheus.monitoring.svc:9090
          access: proxy
          isDefault: true
  
  # Default dashboards
  defaultDashboardsEnabled: true
  defaultDashboardsTimezone: Europe/Berlin
  
  # Enable reloader annotation
  podAnnotations:
    reloader.stakater.com/auto: "true"

# Alertmanager
alertmanager:
  enabled: true
  alertmanagerSpec:
    # Schedule only on worker nodes
    nodeSelector:
      node-role.kubernetes.io/worker: "worker"
    
    # Storage
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 2Gi
    
    # Resources
    resources:
      requests:
        cpu: 10m
        memory: 64Mi
      limits:
        memory: 128Mi
    
    # Enable reloader annotation
    podMetadata:
      annotations:
        reloader.stakater.com/auto: "true"

# Node Exporter - Metrics from all nodes
nodeExporter:
  enabled: true

# Kube State Metrics - K8s object metrics
kubeStateMetrics:
  enabled: true
  nodeSelector:
    node-role.kubernetes.io/worker: "worker"

# Default ServiceMonitors
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: true
    configReloaders: true
    general: true
    k8s: true
    kubeApiserverAvailability: true
    kubeApiserverSlos: true
    kubelet: true
    kubeProxy: true
    kubePrometheusGeneral: true
    kubePrometheusNodeRecording: true
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    kubeScheduler: true
    kubeStateMetrics: true
    network: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true

# Monitoring K3s components
kubeControllerManager:
  enabled: true
  endpoints:
    - 192.168.2.2   # raspi4
    - 192.168.2.9   # raspi5
    - 192.168.2.12  # ubuntu-1

kubeScheduler:
  enabled: true
  endpoints:
    - 192.168.2.2   # raspi4
    - 192.168.2.9   # raspi5
    - 192.168.2.12  # ubuntu-1

kubeProxy:
  enabled: false  # K3s uses kube-router by default

kubeEtcd:
  enabled: true
  endpoints:
    - 192.168.2.2   # raspi4
    - 192.168.2.9   # raspi5
    - 192.168.2.12  # ubuntu-1
