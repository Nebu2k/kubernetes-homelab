# kube-prometheus-stack Helm values
# Optimized for Raspberry Pi homelab

# Global settings
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: false  # K3s uses embedded SQLite by default
    kubeScheduler: false  # K3s scheduler metrics not exposed
    kubeControllerManager: false  # K3s controller metrics not exposed
    kubeProxy: false  # K3s uses kube-router instead of kube-proxy

# Disable K3s components that don't expose metrics
kubeScheduler:
  enabled: false
kubeControllerManager:
  enabled: false
kubeProxy:
  enabled: false
kubeEtcd:
  enabled: false

# Prometheus configuration
prometheus:
  prometheusSpec:
    # Resource limits (conservative for Pi)
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 2Gi
    
    # Run on worker nodes only
    nodeSelector:
      node-role.kubernetes.io/worker: worker
    
    # Storage configuration
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 20Gi
    
    # Retention policy
    retention: 30d
    retentionSize: "18GB"
    
    # Service monitors
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false

# Grafana configuration
grafana:
  enabled: true
  
  # Admin credentials (change in production!)
  adminPassword: prom-operator
  
  # Run on worker nodes only
  nodeSelector:
    node-role.kubernetes.io/worker: worker
  
  # Persistence
  persistence:
    enabled: true
    storageClassName: longhorn
    size: 5Gi
  
  # Ingress will be configured in overlays/production
  ingress:
    enabled: false
  
  # Resources (conservative for Pi)
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Pre-installed dashboards
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default
  
  # Additional dashboards
  dashboards:
    default:
      # Kubernetes cluster overview
      kubernetes-cluster:
        gnetId: 7249
        revision: 1
        datasource: Prometheus
      # Node exporter full
      node-exporter:
        gnetId: 1860
        revision: 31
        datasource: Prometheus
      # Longhorn dashboard
      longhorn:
        gnetId: 13032
        revision: 6
        datasource: Prometheus
      # NGINX Ingress Controller
      nginx-ingress:
        gnetId: 9614
        revision: 1
        datasource: Prometheus
      # UniFi Poller - Client Insights
      unifi-client-insights:
        gnetId: 11315
        revision: 9
        datasource: Prometheus
      # UniFi Poller - Network Sites
      unifi-sites:
        gnetId: 11311
        revision: 5
        datasource: Prometheus
      # UniFi Poller - UAP Insights
      unifi-uap:
        gnetId: 11314
        revision: 10
        datasource: Prometheus
      # UniFi Poller - USW Insights
      unifi-usw:
        gnetId: 11312
        revision: 9
        datasource: Prometheus

# Alert Manager
alertmanager:
  enabled: true
  
  # SMTP configuration for email alerts
  config:
    global:
      resolve_timeout: 5m
      smtp_smarthost: 'email-smtp.eu-west-1.amazonaws.com:587'
      smtp_from: 'alert@elmstreet79.de'
      smtp_auth_username_file: '/etc/alertmanager/secrets/alertmanager-smtp-credentials/username'
      smtp_auth_password_file: '/etc/alertmanager/secrets/alertmanager-smtp-credentials/password'
      smtp_require_tls: true
    inhibit_rules:
      - source_matchers:
          - 'severity = critical'
        target_matchers:
          - 'severity =~ warning|info'
        equal:
          - 'namespace'
          - 'alertname'
      - source_matchers:
          - 'severity = warning'
        target_matchers:
          - 'severity = info'
        equal:
          - 'namespace'
          - 'alertname'
      - source_matchers:
          - 'alertname = InfoInhibitor'
        target_matchers:
          - 'severity = info'
        equal:
          - 'namespace'
      - target_matchers:
          - 'alertname = InfoInhibitor'
    route:
      group_by: ['namespace', 'alertname']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
      receiver: 'email'
      routes:
        - receiver: 'null'
          matchers:
            - alertname = "Watchdog"
    receivers:
      - name: 'null'
      - name: 'email'
        email_configs:
          - to: 'alert@elmstreet79.de'
            send_resolved: true
    templates:
      - '/etc/alertmanager/config/*.tmpl'
  
  alertmanagerSpec:
    # Mount SMTP credentials secret
    secrets:
      - alertmanager-smtp-credentials
    
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi
    
    # Run on worker nodes only
    nodeSelector:
      node-role.kubernetes.io/worker: worker
    
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 2Gi

# Node exporter (collects node metrics)
nodeExporter:
  enabled: true

# Kube-state-metrics (cluster state metrics) - note: uses hyphens not camelCase
kube-state-metrics:
  nodeSelector:
    node-role.kubernetes.io/worker: "worker"

# Prometheus Operator
prometheusOperator:
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Run on worker nodes only
  nodeSelector:
    node-role.kubernetes.io/worker: worker
  
  # Enable monitoring of namespaces
  namespaces:
    releaseNamespace: true
    additional:
      - kube-system
      - ingress-nginx
      - cert-manager
      - longhorn-system
      - home-assistant
      - teslamate

# Service Monitors for additional components
additionalServiceMonitors:
  # Monitor NGINX Ingress Controller
  - name: nginx-ingress-controller
    selector:
      matchLabels:
        app.kubernetes.io/name: ingress-nginx
    namespaceSelector:
      matchNames:
        - ingress-nginx
    endpoints:
      - port: metrics
        interval: 30s
