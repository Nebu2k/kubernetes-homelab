#!/bin/bash

# Pre-commit hook to auto-generate README.md
# Runs on EVERY commit to ensure single point of truth

set -e

echo "üìù Regenerating README.md (single point of truth)..."

# Initialize conda for shell script
eval "$(/opt/homebrew/bin/brew shellenv 2>/dev/null || true)"
eval "$(conda shell.bash hook 2>/dev/null || /opt/homebrew/Caskroom/miniconda/base/bin/conda shell.bash hook 2>/dev/null || true)"

# Check if conda environment exists
if ! conda env list | grep -q "^jinja2 "; then
    echo "‚ùå Error: Conda environment 'jinja2' not found"
    echo "   Run: conda create -n jinja2 python=3.11 -y && conda run -n jinja2 pip install -r docs-generator/requirements.txt"
    exit 1
fi

# Regenerate README
cd docs-generator
conda run -n jinja2 python generate_readme.py
cd ..

# Check if README.md was modified
if git diff --name-only README.md | grep -q "README.md"; then
    echo "‚úÖ README.md regenerated"
    
    # Auto-stage the updated README
    git add README.md
    
    echo "‚ú® README.md auto-added to commit"
else
    echo "‚ÑπÔ∏è  README.md unchanged"
fi

exit 0
