---
apiVersion: v1
kind: ConfigMap
metadata:
  name: adguard-dns-sync
  namespace: private-services
data:
  sync-dns.sh: |
    #!/bin/sh
    set -e

    # Install jq for JSON parsing
    apk add --no-cache jq > /dev/null 2>&1

    ADGUARD_HOST="${ADGUARD_HOST}"
    ADGUARD_USER="${ADGUARD_USER}"
    ADGUARD_PASS="${ADGUARD_PASS}"
    INGRESS_IP="${INGRESS_IP}"
    DOMAIN_SUFFIX="${DOMAIN_SUFFIX}"

    echo "Syncing DNS rewrites to AdGuard Home at ${ADGUARD_HOST}..."

    # Get service account token
    TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)

    # Get all hostnames from both standard Ingresses and Traefik IngressRoutes
    echo "Fetching internal ingresses (with internal-ca-issuer or letsencrypt-prod)..."

    # Query standard Ingresses with internal-ca-issuer or letsencrypt-prod
    INGRESS_DOMAINS=$(curl -s -k -H "Authorization: Bearer ${TOKEN}" \
      "https://kubernetes.default.svc/apis/networking.k8s.io/v1/ingresses?limit=500" | \
      jq -r ".items[] | 
        select(.metadata.annotations[\"cert-manager.io/cluster-issuer\"] == \"internal-ca-issuer\" or 
               .metadata.annotations[\"cert-manager.io/cluster-issuer\"] == \"letsencrypt-prod\") |
        select(.metadata.annotations[\"adguard-dns-sync/exclude\"] != \"true\") |
        .spec.rules[]?.host | 
        select(. != null and endswith(\"${DOMAIN_SUFFIX}\"))" | \
      sort -u)

    # Query Traefik IngressRoutes with internal-ca-issuer or letsencrypt-prod annotation
    INGRESSROUTE_DOMAINS=$(curl -s -k -H "Authorization: Bearer ${TOKEN}" \
      "https://kubernetes.default.svc/apis/traefik.io/v1alpha1/ingressroutes?limit=500" | \
      jq -r ".items[] | 
        select(.metadata.annotations[\"cert-manager.io/cluster-issuer\"] == \"internal-ca-issuer\" or 
               .metadata.annotations[\"cert-manager.io/cluster-issuer\"] == \"letsencrypt-prod\") |
        select(.metadata.annotations[\"adguard-dns-sync/exclude\"] != \"true\") |
        select(.spec.tls.secretName != null) |
        .spec.routes[]? | select(.match != null) | 
        .match | 
        capture(\"Host\\\\(\`(?<host>[^\`]+)\`\\\\)\").host | 
        select(endswith(\"${DOMAIN_SUFFIX}\"))" | \
      sort -u)

    # Combine both sources
    DOMAINS=$(echo "${INGRESS_DOMAINS}"; echo "${INGRESSROUTE_DOMAINS}" | grep -v '^$' | sort -u)

    echo "Found domains (internal + external with split-horizon):"
    echo "${DOMAINS}"
    echo ""

    # Get current rewrites from AdGuard that point to our INGRESS_IP and end with DOMAIN_SUFFIX
    CURRENT_REWRITES=$(curl -s -u "${ADGUARD_USER}:${ADGUARD_PASS}" \
      "http://${ADGUARD_HOST}/control/rewrite/list" | \
      jq -r ".[] | select(.answer == \"${INGRESS_IP}\" and (.domain | endswith(\"${DOMAIN_SUFFIX}\"))) | .domain" | \
      sort -u)

    echo "Current AdGuard rewrites for ${DOMAIN_SUFFIX}:"
    echo "${CURRENT_REWRITES}"
    echo ""

    # Remove rewrites that are no longer in Kubernetes
    echo "Checking for orphaned rewrites..."
    REMOVED_COUNT=0
    for CURRENT_DOMAIN in ${CURRENT_REWRITES}; do
      if ! echo "${DOMAINS}" | grep -qx "${CURRENT_DOMAIN}"; then
        echo "âœ— Removing orphaned ${CURRENT_DOMAIN}"
        curl -s -X POST "http://${ADGUARD_HOST}/control/rewrite/delete" \
          -u "${ADGUARD_USER}:${ADGUARD_PASS}" \
          -H "Content-Type: application/json" \
          -d "{\"domain\":\"${CURRENT_DOMAIN}\",\"answer\":\"${INGRESS_IP}\"}" > /dev/null
        echo "âœ“ ${CURRENT_DOMAIN} removed"
        REMOVED_COUNT=$((REMOVED_COUNT + 1))
      fi
    done
    
    if [ ${REMOVED_COUNT} -eq 0 ]; then
      echo "No orphaned rewrites found"
    fi
    echo ""

    # Add new rewrites
    echo "Adding/updating rewrites..."
    ADDED_COUNT=0
    SKIPPED_COUNT=0
    for DOMAIN in ${DOMAINS}; do
      if [ -n "${DOMAIN}" ]; then
        if echo "${CURRENT_REWRITES}" | grep -qx "${DOMAIN}"; then
          echo "âœ“ ${DOMAIN} already exists"
          SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
        else
          echo "â†’ Adding ${DOMAIN} -> ${INGRESS_IP}"
          curl -s -X POST "http://${ADGUARD_HOST}/control/rewrite/add" \
            -u "${ADGUARD_USER}:${ADGUARD_PASS}" \
            -H "Content-Type: application/json" \
            -d "{\"domain\":\"${DOMAIN}\",\"answer\":\"${INGRESS_IP}\"}" > /dev/null
          echo "âœ“ ${DOMAIN} added"
          ADDED_COUNT=$((ADDED_COUNT + 1))
        fi
      fi
    done

    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ“Š Sync Summary:"
    echo "   âœ“ Skipped (already exists): ${SKIPPED_COUNT}"
    echo "   â• Added: ${ADDED_COUNT}"
    echo "   âœ— Removed: ${REMOVED_COUNT}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "âœ… AdGuard DNS sync complete!"
---
# PostSync Hook: Runs after every ArgoCD sync
apiVersion: batch/v1
kind: Job
metadata:
  name: adguard-dns-sync-postsync
  namespace: private-services
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300 # Clean up after 5min
  template:
    spec:
      serviceAccountName: adguard-dns-sync
      restartPolicy: OnFailure
      containers:
        - name: sync
          image: alpine/curl:latest
          command: ["/bin/sh", "/scripts/sync-dns.sh"]
          env:
            - name: ADGUARD_HOST
              value: "192.168.2.9:8080"
            - name: INGRESS_IP
              value: "192.168.2.250"
            - name: DOMAIN_SUFFIX
              value: "elmstreet79.de"
            - name: ADGUARD_USER
              valueFrom:
                secretKeyRef:
                  name: adguard-credentials
                  key: username
            - name: ADGUARD_PASS
              valueFrom:
                secretKeyRef:
                  name: adguard-credentials
                  key: password
          volumeMounts:
            - name: scripts
              mountPath: /scripts
      volumes:
        - name: scripts
          configMap:
            name: adguard-dns-sync
            defaultMode: 0755
---
# CronJob: Runs every 5 minutes
apiVersion: batch/v1
kind: CronJob
metadata:
  name: adguard-dns-sync
  namespace: private-services
spec:
  schedule: "*/5 * * * *" # Every 5 minutes
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 3600 # Clean up after 1h
      template:
        spec:
          serviceAccountName: adguard-dns-sync
          restartPolicy: OnFailure
          containers:
            - name: sync
              image: alpine/curl:latest
              command: ["/bin/sh", "/scripts/sync-dns.sh"]
              env:
                - name: ADGUARD_HOST
                  value: "192.168.2.9:8080"
                - name: INGRESS_IP
                  value: "192.168.2.250"
                - name: DOMAIN_SUFFIX
                  value: "elmstreet79.de"
                - name: ADGUARD_USER
                  valueFrom:
                    secretKeyRef:
                      name: adguard-credentials
                      key: username
                - name: ADGUARD_PASS
                  valueFrom:
                    secretKeyRef:
                      name: adguard-credentials
                      key: password
              volumeMounts:
                - name: scripts
                  mountPath: /scripts
          volumes:
            - name: scripts
              configMap:
                name: adguard-dns-sync
                defaultMode: 0755
