---
apiVersion: v1
kind: ConfigMap
metadata:
  name: pangolin-resource-sync
  namespace: cert-manager
data:
  DOMAIN: "elmstreet79.de"
  TARGET_IP: "192.168.2.250"  # Traefik LoadBalancer IP
  PANGOLIN_API_URL: "https://pangolin.elmstreet79.de"
  # ORG_ID and SITE_ID will be provided in the secret or can be hardcoded here
  # ORG_ID: "your-org-id"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: pangolin-resource-sync-script
  namespace: cert-manager
data:
  sync-resources.sh: |
    #!/bin/sh
    set -e

    # Install jq for JSON parsing
    apk add --no-cache jq > /dev/null 2>&1

    API_TOKEN="${API_TOKEN}"
    DOMAIN="${DOMAIN}"
    TARGET_IP="${TARGET_IP}"
    PANGOLIN_API_URL="${PANGOLIN_API_URL}"
    ORG_ID="${ORG_ID}"

    echo "Syncing Pangolin resources for ${DOMAIN}..."
    echo "Target IP: ${TARGET_IP}"
    echo "API URL: ${PANGOLIN_API_URL}"
    echo "Organization: ${ORG_ID}"
    echo ""

    # Get Site ID dynamically from Pangolin API
    echo "Fetching Site ID for domain ${DOMAIN}..."
    SITES_RESPONSE=$(curl -s -X GET "${PANGOLIN_API_URL}/v1/org/${ORG_ID}/sites" \
      -H "Authorization: Bearer ${API_TOKEN}" \
      -H "Content-Type: application/json")

    if echo "${SITES_RESPONSE}" | jq -e '.error' > /dev/null 2>&1; then
      echo "âŒ Error fetching sites from Pangolin:"
      echo "${SITES_RESPONSE}" | jq -r '.error // .message'
      exit 1
    fi

    # Find the site matching our domain
    SITE_ID=$(echo "${SITES_RESPONSE}" | jq -r ".sites[]? | select(.domain == \"${DOMAIN}\") | .id")
    
    if [ -z "${SITE_ID}" ]; then
      echo "âŒ Could not find site for domain ${DOMAIN}"
      echo "Available sites:"
      echo "${SITES_RESPONSE}" | jq -r '.sites[]? | "  - \(.domain) (ID: \(.id))"'
      exit 1
    fi
    
    echo "âœ“ Found Site ID: ${SITE_ID}"
    echo ""

    # Get service account token for Kubernetes API
    K8S_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)

    # Get all ingress hostnames from Kubernetes API
    echo "Fetching public ingresses (with letsencrypt-prod)..."

    # Query all ingresses - only those with cert-manager.io/cluster-issuer: letsencrypt-prod
    INGRESS_HOSTS=$(curl -s -k -H "Authorization: Bearer ${K8S_TOKEN}" \
      "https://kubernetes.default.svc/apis/networking.k8s.io/v1/ingresses?limit=500" | \
      jq -r ".items[] | 
        select(.metadata.annotations[\"cert-manager.io/cluster-issuer\"] == \"letsencrypt-prod\") | 
        .spec.rules[]?.host | 
        select(. != null and endswith(\"${DOMAIN}\"))" | \
      sort -u)

    echo "Found public ingress domains:"
    echo "${INGRESS_HOSTS}"
    echo ""

    # Get existing Pangolin resources for this site
    echo "Fetching existing Pangolin resources..."
    SITE_INFO=$(curl -s -X GET "${PANGOLIN_API_URL}/v1/org/${ORG_ID}/site/${SITE_ID}" \
      -H "Authorization: Bearer ${API_TOKEN}" \
      -H "Content-Type: application/json")

    # Check if the API call was successful
    if echo "${SITE_INFO}" | jq -e '.error' > /dev/null 2>&1; then
      echo "âŒ Error fetching site info from Pangolin:"
      echo "${SITE_INFO}" | jq -r '.error // .message'
      exit 1
    fi

    # Extract existing resources
    EXISTING_RESOURCES=$(echo "${SITE_INFO}" | jq -r '.resources // []')
    
    echo "Current Pangolin resources:"
    echo "${EXISTING_RESOURCES}" | jq -r '.[] | "\(.subdomain) -> Target ID: \(.targets[0]?.id // "none")"'
    echo ""

    # Remove resources that are no longer in Kubernetes
    echo "Checking for orphaned Pangolin resources..."
    ORPHANED_COUNT=0
    
    echo "${EXISTING_RESOURCES}" | jq -c '.[]' | while read -r resource; do
      RESOURCE_ID=$(echo "${resource}" | jq -r '.id')
      SUBDOMAIN=$(echo "${resource}" | jq -r '.subdomain')
      FULL_DOMAIN="${SUBDOMAIN}.${DOMAIN}"
      
      if ! echo "${INGRESS_HOSTS}" | grep -q "^${FULL_DOMAIN}$"; then
        echo "âœ— Removing orphaned resource: ${FULL_DOMAIN}"
        
        DELETE_RESULT=$(curl -s -X DELETE \
          "${PANGOLIN_API_URL}/v1/org/${ORG_ID}/site/${SITE_ID}/resource/${RESOURCE_ID}" \
          -H "Authorization: Bearer ${API_TOKEN}" \
          -H "Content-Type: application/json")
        
        if ! echo "${DELETE_RESULT}" | jq -e '.error' > /dev/null 2>&1; then
          echo "âœ“ ${FULL_DOMAIN} removed"
          ORPHANED_COUNT=$((ORPHANED_COUNT + 1))
        else
          echo "âš ï¸  Failed to remove ${FULL_DOMAIN}"
          echo "${DELETE_RESULT}" | jq -r '.error // .message'
        fi
      fi
    done
    
    if [ ${ORPHANED_COUNT} -eq 0 ]; then
      echo "No orphaned resources found"
    fi
    echo ""

    # Add or update resources for all ingress domains
    echo "Adding/updating Pangolin resources..."
    ADDED_COUNT=0
    UPDATED_COUNT=0
    SKIPPED_COUNT=0
    
    echo "${INGRESS_HOSTS}" | while read -r INGRESS_HOST; do
      if [ -z "${INGRESS_HOST}" ]; then
        continue
      fi
      
      # Extract subdomain (remove .elmstreet79.de)
      SUBDOMAIN=$(echo "${INGRESS_HOST}" | sed "s/\.${DOMAIN}$//")
      
      # Check if resource already exists
      EXISTING_RESOURCE=$(echo "${EXISTING_RESOURCES}" | jq -r ".[] | select(.subdomain == \"${SUBDOMAIN}\")")
      
      if [ -n "${EXISTING_RESOURCE}" ]; then
        # Check if target IP is correct
        RESOURCE_ID=$(echo "${EXISTING_RESOURCE}" | jq -r '.id')
        TARGET_ID=$(echo "${EXISTING_RESOURCE}" | jq -r '.targets[0]?.id // ""')
        
        if [ -n "${TARGET_ID}" ]; then
          # Get target details to check IP
          TARGET_INFO=$(curl -s -X GET "${PANGOLIN_API_URL}/v1/target/${TARGET_ID}" \
            -H "Authorization: Bearer ${API_TOKEN}" \
            -H "Content-Type: application/json")
          
          CURRENT_IP=$(echo "${TARGET_INFO}" | jq -r '.address // ""')
          
          if [ "${CURRENT_IP}" = "${TARGET_IP}" ]; then
            echo "âœ“ ${INGRESS_HOST} already exists and is correct"
            SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
          else
            echo "ğŸ”„ Updating ${INGRESS_HOST} target (${CURRENT_IP} -> ${TARGET_IP})"
            # Update target
            UPDATE_RESULT=$(curl -s -X POST "${PANGOLIN_API_URL}/v1/target/${TARGET_ID}" \
              -H "Authorization: Bearer ${API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data "{\"address\":\"${TARGET_IP}\",\"port\":443}")
            
            if ! echo "${UPDATE_RESULT}" | jq -e '.error' > /dev/null 2>&1; then
              echo "âœ“ ${INGRESS_HOST} updated"
              UPDATED_COUNT=$((UPDATED_COUNT + 1))
            else
              echo "âš ï¸  Failed to update ${INGRESS_HOST}"
              echo "${UPDATE_RESULT}" | jq -r '.error // .message'
            fi
          fi
        else
          echo "âš ï¸  ${INGRESS_HOST} exists but has no target, skipping"
          SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
        fi
      else
        # Create new resource
        echo "â†’ Adding ${INGRESS_HOST} -> ${TARGET_IP}:443"
        
        # First create the resource
        CREATE_RESOURCE=$(curl -s -X PUT \
          "${PANGOLIN_API_URL}/v1/org/${ORG_ID}/site/${SITE_ID}/resource" \
          -H "Authorization: Bearer ${API_TOKEN}" \
          -H "Content-Type: application/json" \
          --data "{\"subdomain\":\"${SUBDOMAIN}\",\"description\":\"Auto-synced from Kubernetes\"}")
        
        if echo "${CREATE_RESOURCE}" | jq -e '.error' > /dev/null 2>&1; then
          echo "âš ï¸  Failed to create resource ${INGRESS_HOST}"
          echo "${CREATE_RESOURCE}" | jq -r '.error // .message'
          continue
        fi
        
        NEW_RESOURCE_ID=$(echo "${CREATE_RESOURCE}" | jq -r '.id')
        
        # Then create the target for this resource
        CREATE_TARGET=$(curl -s -X PUT \
          "${PANGOLIN_API_URL}/v1/resource/${NEW_RESOURCE_ID}/target" \
          -H "Authorization: Bearer ${API_TOKEN}" \
          -H "Content-Type: application/json" \
          --data "{\"address\":\"${TARGET_IP}\",\"port\":443}")
        
        if ! echo "${CREATE_TARGET}" | jq -e '.error' > /dev/null 2>&1; then
          echo "âœ“ ${INGRESS_HOST} added"
          ADDED_COUNT=$((ADDED_COUNT + 1))
        else
          echo "âš ï¸  Resource created but failed to add target for ${INGRESS_HOST}"
          echo "${CREATE_TARGET}" | jq -r '.error // .message'
        fi
      fi
    done

    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ“Š Sync Summary:"
    echo "   âœ“ Skipped (already correct): ${SKIPPED_COUNT}"
    echo "   â• Added: ${ADDED_COUNT}"
    echo "   ğŸ”„ Updated: ${UPDATED_COUNT}"
    echo "   âœ— Removed: ${ORPHANED_COUNT}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "âœ… Pangolin resource sync complete!"
