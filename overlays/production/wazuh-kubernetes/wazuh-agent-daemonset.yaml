---
apiVersion: v1
kind: Namespace
metadata:
  name: wazuh
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: wazuh-agent
  namespace: wazuh
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: wazuh-agent
rules:
  - apiGroups: [""]
    resources:
      - pods
      - nodes
      - services
      - endpoints
      - namespaces
      - events
      - persistentvolumes
      - persistentvolumeclaims
      - configmaps
      - secrets
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources:
      - deployments
      - daemonsets
      - replicasets
      - statefulsets
    verbs: ["get", "list", "watch"]
  - apiGroups: ["batch"]
    resources:
      - jobs
      - cronjobs
    verbs: ["get", "list", "watch"]
  - apiGroups: ["networking.k8s.io"]
    resources:
      - networkpolicies
      - ingresses
    verbs: ["get", "list", "watch"]
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources:
      - roles
      - rolebindings
      - clusterroles
      - clusterrolebindings
    verbs: ["get", "list", "watch"]
  - apiGroups: ["policy"]
    resources:
      - podsecuritypolicies
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: wazuh-agent
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: wazuh-agent
subjects:
  - kind: ServiceAccount
    name: wazuh-agent
    namespace: wazuh
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: wazuh-kubernetes-config
  namespace: wazuh
data:
  ossec.conf: |
    <ossec_config>
      <client>
        <server>
          <address>192.168.2.14</address>
          <port>1514</port>
          <protocol>tcp</protocol>
        </server>
        <config-profile>kubernetes</config-profile>
        <notify_time>10</notify_time>
        <time-reconnect>60</time-reconnect>
        <auto_restart>yes</auto_restart>
      </client>

      <client_buffer>
        <disabled>no</disabled>
        <queue_size>5000</queue_size>
        <events_per_second>500</events_per_second>
      </client_buffer>

      <logging>
        <log_format>plain</log_format>
      </logging>

      <!-- Kubernetes API monitoring -->
      <wodle name="command">
        <disabled>no</disabled>
        <tag>kubernetes</tag>
        <command>/var/ossec/wodles/kubernetes/kubernetes.py</command>
        <interval>60s</interval>
        <ignore_output>no</ignore_output>
        <run_on_start>yes</run_on_start>
        <timeout>0</timeout>
      </wodle>

      <!-- File integrity monitoring for Kubernetes config -->
      <syscheck>
        <disabled>no</disabled>
        <frequency>3600</frequency>
        <scan_on_start>yes</scan_on_start>

        <!-- Monitor Kubernetes configs on host (via hostPath) -->
        <directories check_all="yes" realtime="no">/host/etc/kubernetes</directories>
        <directories check_all="yes" realtime="no">/host/var/lib/rancher/k3s</directories>
      </syscheck>

      <!-- Log collection -->
      <localfile>
        <log_format>syslog</log_format>
        <location>/var/log/kubernetes/*.log</location>
      </localfile>

      <localfile>
        <log_format>json</log_format>
        <location>/var/log/containers/*.log</location>
      </localfile>

      <!-- Active Response disabled in Kubernetes -->
      <active-response>
        <disabled>yes</disabled>
      </active-response>

    </ossec_config>

  kubernetes.yml: |
    #!/usr/bin/env python3
    # Kubernetes API monitoring configuration
    
    # API Server URL (uses in-cluster service account)
    api_server: https://kubernetes.default.svc
    
    # Monitoring interval in seconds
    interval: 60
    
    # Resources to monitor
    resources:
      - pods
      - services
      - deployments
      - replicasets
      - daemonsets
      - statefulsets
      - configmaps
      - secrets
      - ingresses
      - networkpolicies
      - persistentvolumes
      - persistentvolumeclaims
      - nodes
      - namespaces
      - events
    
    # Alert on suspicious activities
    alerts:
      - privileged_containers
      - host_network
      - host_pid
      - capabilities_added
      - read_only_root_filesystem_false
      - secrets_access
      - configmap_changes
      - rbac_changes
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: wazuh-agent
  namespace: wazuh
  labels:
    app: wazuh-agent
spec:
  selector:
    matchLabels:
      app: wazuh-agent
  template:
    metadata:
      labels:
        app: wazuh-agent
    spec:
      serviceAccountName: wazuh-agent
      hostNetwork: true
      hostPID: true
      hostIPC: true
      containers:
        - name: wazuh-agent
          image: wazuh/wazuh-agent:4.14.1
          env:
            - name: WAZUH_MANAGER
              value: "192.168.2.14"
            - name: WAZUH_AGENT_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: WAZUH_PROTOCOL
              value: "tcp"
          securityContext:
            privileged: true
            capabilities:
              add:
                - SYS_ADMIN
                - SYS_RESOURCE
                - SYS_PTRACE
                - NET_ADMIN
                - NET_RAW
          volumeMounts:
            - name: ossec-conf
              mountPath: /var/ossec/etc/ossec.conf
              subPath: ossec.conf
              readOnly: true
            - name: kubernetes-config
              mountPath: /var/ossec/wodles/kubernetes/config.yml
              subPath: kubernetes.yml
              readOnly: true
            # Host filesystem access for FIM
            - name: host-etc
              mountPath: /host/etc
              readOnly: true
            - name: host-var
              mountPath: /host/var
              readOnly: true
            # Container logs
            - name: container-logs
              mountPath: /var/log/containers
              readOnly: true
            # Kubernetes logs
            - name: kubernetes-logs
              mountPath: /var/log/kubernetes
              readOnly: true
            # Docker socket for container inspection
            - name: docker-socket
              mountPath: /var/run/docker.sock
              readOnly: true
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
      volumes:
        - name: ossec-conf
          configMap:
            name: wazuh-kubernetes-config
            items:
              - key: ossec.conf
                path: ossec.conf
        - name: kubernetes-config
          configMap:
            name: wazuh-kubernetes-config
            items:
              - key: kubernetes.yml
                path: kubernetes.yml
        - name: host-etc
          hostPath:
            path: /etc
        - name: host-var
          hostPath:
            path: /var
        - name: container-logs
          hostPath:
            path: /var/log/containers
        - name: kubernetes-logs
          hostPath:
            path: /var/log/pods
        - name: docker-socket
          hostPath:
            path: /var/run/containerd/containerd.sock
      tolerations:
        # Run on all nodes including control plane
        - effect: NoSchedule
          operator: Exists
        - effect: NoExecute
          operator: Exists
